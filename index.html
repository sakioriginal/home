<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‚²å…ãƒ­ã‚°ï¼ˆãƒ•ãƒ«ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===============================
   å…¨ä½“ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–ï¼‰
=============================== */
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:10px;
}
h1 {
  text-align:center;
  margin:10px 0 20px;
}
.card {
  background:white;
  margin:10px 0;
  padding:12px;
  border-radius:10px;
  box-shadow:0 1px 4px rgba(0,0,0,0.1);
}
button {
  padding:8px 12px;
  margin:5px 0;
  font-size:16px;
  border:none;
  border-radius:6px;
  background:#4CAF50;
  color:white;
}
.smallBtn {
  padding:4px 8px;
  font-size:12px;
  background:#0288d1;
}
input, select, textarea {
  padding:6px;
  margin:4px 0;
  font-size:15px;
  width:100%;
  box-sizing:border-box;
}



/* ===============================
   ãƒ­ã‚°è¡¨ç¤º
=============================== */
.log {
  padding:8px;
  border-bottom:1px solid #ddd;
  display:flex;
  flex-direction:column;
}
.logTop {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logBtns {
  display:flex;
  gap:10px;
}

/* ===============================
   å±¥æ­´æŠ˜ã‚ŠãŸãŸã¿
=============================== */
#logsContainer {
  display:none;
}

/* ===============================
   âš™ï¸ è¨­å®šãƒœã‚¿ãƒ³
=============================== */
#gear {
  position:fixed;
  top:10px;
  right:12px;
  font-size:26px;
  cursor:pointer;
}
#settingsPanel {
  display:none;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,0.2);
}

/* ===============================
   ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆiOSé¢¨ï¼‰
=============================== */
#modalBG {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.35);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
#modal {
  background:white;
  width:90%;
  max-width:380px;
  border-radius:12px;
  padding:16px;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
}
.modalTitle {
  font-size:18px;
  margin-bottom:10px;
}
.modalBtnRow {
  margin-top:12px;
  display:flex;
  justify-content:space-between;
}
.modalClose {
  background:#aaa;
}
textarea {
  height:60px;
}
</style>
</head>

<body>

<h1>è‚²å…ãƒ­ã‚°</h1>

<!-- âš™ï¸ è¨­å®š -->
<div id="gear" onclick="toggleSettings()">âš™ï¸</div>
<div id="settingsPanel">
  <h3>è¨­å®š</h3>
  ä½¿ç”¨è€…åï¼ˆç«¯æœ«ï¼‰  
  <input id="username" placeholder="ã‚ãªãŸã®åå‰">
  <button onclick="saveUsername()">ä¿å­˜</button>
  <hr>
  API KEY  
  <input id="apiKeyInput">
  BIN ID  
  <input id="binIdInput">
  <button onclick="saveInitialSettings()">ä¿å­˜</button>
</div>

<!-- åˆå›è¨­å®š -->
<div id="setupPage" class="card" style="display:none;">
  <h2>åˆå›è¨­å®š</h2>
  <input id="apiKeyInput2" placeholder="API KEY">
  <input id="binIdInput2" placeholder="BIN ID">
  <button onclick="saveInitialSettings2()">ä¿å­˜</button>
</div>

<!-- ãƒ¡ã‚¤ãƒ³UI -->
<div id="mainApp" style="display:none;">

  <!-- ãƒŸãƒ«ã‚¯ -->
  <div class="card">
    <h2>ğŸ¼ ãƒŸãƒ«ã‚¯</h2>
    <button onclick="makeMilk()">ä½œã£ãŸ</button>
    <button onclick="fedMilk()">é£²ã¾ã›ãŸ</button>

    <br>
    æˆä¹³é–“éš”ï¼š  
    <select id="interval" onchange="onIntervalChange()">
      <option value="2.5">2.5æ™‚é–“</option>
      <option value="3">3æ™‚é–“</option>
      <option value="4">4æ™‚é–“</option>
    </select>

    <h3 id="nextFeed">æ¬¡ã®æˆä¹³ï¼š--</h3>
  </div>

  <!-- å†·å´ -->
  <div class="card">
    <h2>â„ï¸ å†·å´</h2>
    åˆæœŸæ¸©åº¦ï¼š<input id="startTemp" type="number" value="70">  
    é‡ï¼š<input id="milkVol" type="number" value="200">  
    <button onclick="manualStartCooldown()">å†·å´é–‹å§‹</button>
    <h3 id="cooldownStatus">--</h3>
  </div>

  <!-- ã‚ªãƒ ãƒ„ -->
  <div class="card">
    <h2>ğŸ’© ã‚ªãƒ ãƒ„</h2>
    <button onclick="addDiaper('pee')">ãŠã—ã£ã“</button>
    <button onclick="addDiaper('poo')">ã†ã‚“ã¡</button>
  </div>

  <!-- æ–°è¦è¿½åŠ  -->
  <div class="card">
    <h2>ï¼‹ æ‰‹å‹•è¿½åŠ </h2>
    <button onclick="manualAdd('milk-made')">ğŸ¼ ãƒŸãƒ«ã‚¯ä½œæˆ</button>
    <button onclick="manualAdd('milk-fed')">ğŸ¼ æˆä¹³</button>
    <button onclick="manualAdd('pee')">ğŸ’§ ãŠã—ã£ã“</button>
    <button onclick="manualAdd('poo')">ğŸ’© ã†ã‚“ã¡</button>
    <button onclick="manualAdd('memo')">ğŸ“ ãƒ¡ãƒ¢</button>
  </div>

  <!-- ãƒ­ã‚° -->
  <div class="card">
    <h2 onclick="toggleLogs()">ğŸ“– å±¥æ­´ â–¼</h2>
    <div id="logsContainer">
      <div id="logs">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
  </div>

</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modalBG">
  <div id="modal">
    <div class="modalTitle">ç·¨é›†</div>

    <label>ç¨®é¡</label>
    <select id="m_type">
      <option value="milk-made">ãƒŸãƒ«ã‚¯ä½œæˆ</option>
      <option value="milk-fed">æˆä¹³</option>
      <option value="pee">ãŠã—ã£ã“</option>
      <option value="poo">ã†ã‚“ã¡</option>
      <option value="memo">ãƒ¡ãƒ¢</option>
    </select>

    <label>æ™‚åˆ»</label>
    <input type="datetime-local" id="m_time">

    <label>é‡(ml)</label>
    <input type="number" id="m_amount">

    <label>æ¸©åº¦(â„ƒ)</label>
    <input type="number" id="m_temp">

    <label>ãƒ¡ãƒ¢</label>
    <textarea id="m_note"></textarea>

    <label>user</label>
    <input id="m_user">

    <div class="modalBtnRow">
      <button class="modalClose" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* ==========
   JavaScript
========== */

let DB = { logs: [] };
let editIndex = null;

/* å…±é€šé–¢æ•° */
function nowDT() {
  return new Date().toISOString().slice(0,16);
}

/* è¨­å®šUI */
function toggleSettings(){
  settingsPanel.style.display =
    settingsPanel.style.display === "none" ? "block" : "none";
}
function saveUsername(){
  localStorage.setItem("username", username.value);
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
}

/* åˆå›è¨­å®š */
function checkSettings(){
  const api = localStorage.getItem("jsonbin_api_key");
  const bin = localStorage.getItem("jsonbin_bin_id");
  if(!api || !bin){
    setupPage.style.display="block";
  } else {
    mainApp.style.display="block";
    loadIntervalSetting();
    refresh();
  }
}
checkSettings();

/* JSONBin */
async function loadData(){
  const api = localStorage.getItem("jsonbin_api_key");
  const bin = localStorage.getItem("jsonbin_bin_id");
  const r = await fetch(`https://api.jsonbin.io/v3/b/${bin}`,{
    headers:{"X-Master-Key":api}
  });
  const j = await r.json();
  return j.record || {logs:[]};
}
async function saveData(d){
  const api = localStorage.getItem("jsonbin_api_key");
  const bin = localStorage.getItem("jsonbin_bin_id");
  await fetch(`https://api.jsonbin.io/v3/b/${bin}`,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "X-Master-Key":api
    },
    body:JSON.stringify(d)
  });
}

/* åˆå›ä¿å­˜ */
function saveInitialSettings(){
  localStorage.setItem("jsonbin_api_key", apiKeyInput.value);
  localStorage.setItem("jsonbin_bin_id", binIdInput.value);
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  location.reload();
}
function saveInitialSettings2(){
  localStorage.setItem("jsonbin_api_key", apiKeyInput2.value);
  localStorage.setItem("jsonbin_bin_id", binIdInput2.value);
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  location.reload();
}

/* ãƒ¡ã‚¤ãƒ³æ›´æ–° */
async function refresh(){
  DB = await loadData();
  sortLogs();
  renderLogs();
  calcNextFeeding();
}

/* ã‚½ãƒ¼ãƒˆ */
function sortLogs(){
  DB.logs.sort((a,b)=> b.time - a.time);
}

/* ãƒŸãƒ«ã‚¯ä½œæˆ */
function makeMilk(){
  DB.logs.unshift({
    type:"milk-made",
    time:Date.now(),
    temp:Number(startTemp.value),
    vol:Number(milkVol.value),
    user:localStorage.getItem("username")||"unknown",
    note:""
  });
  saveData(DB);
  refresh();
}

/* æˆä¹³ */
function fedMilk(){
  const amount = prompt("é‡(ml)","150");
  if(!amount) return;
  const now = Date.now();
  const next = now + Number(interval.value)*3600*1000;

  DB.logs.unshift({
    type:"milk-fed",
    time:now,
    amount:Number(amount),
    nextFeeding:next,
    user:localStorage.getItem("username")||"unknown",
    note:""
  });
  saveData(DB);
  refresh();
}

/* ã‚ªãƒ ãƒ„ */
function addDiaper(k){
  DB.logs.unshift({
    type:"diaper",
    kind:k,
    time:Date.now(),
    user:localStorage.getItem("username")||"unknown",
    note:""
  });
  saveData(DB);
  refresh();
}

/* æ‰‹å‹•è¿½åŠ  */
function manualAdd(t){
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æµç”¨ï¼ˆæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ï¼‰
  editIndex = null;
  openModalForType(t);
}

/* ãƒ­ã‚°æç”» */
function renderLogs(){
  logs.innerHTML="";
  DB.logs.forEach((l,i)=>{
    const div = document.createElement("div");
    div.className="log";
    const t = new Date(l.time).toLocaleString();

    let title="";
    if(l.type==="milk-made") title=`ğŸ¼ ãƒŸãƒ«ã‚¯ä½œæˆ ${l.vol}ml / ${l.temp}â„ƒ`;
    else if(l.type==="milk-fed") title=`ğŸ¼ æˆä¹³ ${l.amount}ml`;
    else if(l.type==="diaper"){
      title = (l.kind==="pee"?"ğŸ’§ ãŠã—ã£ã“":"ğŸ’© ã†ã‚“ã¡");
    }
    else if(l.type==="memo") title = `ğŸ“ ãƒ¡ãƒ¢`;

    const top = document.createElement("div");
    top.className="logTop";
    top.innerHTML = `<div>${title}<br><small>${t} - ${l.user}</small></div>`;

    const btns = document.createElement("div");
    btns.className="logBtns";

    const editBtn = document.createElement("button");
    editBtn.textContent="âœ";
    editBtn.className="smallBtn";
    editBtn.onclick = ()=>openModal(i);

    const delBtn = document.createElement("button");
    delBtn.textContent="ğŸ—‘";
    delBtn.className="smallBtn";
    delBtn.style.background="#d32f2f";
    delBtn.onclick = ()=>deleteLog(i);

    btns.appendChild(editBtn);
    btns.appendChild(delBtn);

    top.appendChild(btns);
    div.appendChild(top);

    if(l.note){
      const note = document.createElement("div");
      note.innerHTML = `<small>ãƒ¡ãƒ¢ï¼š${l.note}</small>`;
      div.appendChild(note);
    }

    logs.appendChild(div);
  });
}

/* ãƒ­ã‚°å‰Šé™¤ */
function deleteLog(i){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  DB.logs.splice(i,1);
  saveData(DB);
  refresh();
}

/* ãƒ­ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹• */
function openModal(i){
  editIndex = i;
  const l = DB.logs[i];

  m_type.value = l.type;
  m_time.value = new Date(l.time).toISOString().slice(0,16);

  m_amount.value = l.amount || "";
  m_temp.value = l.temp || "";
  m_note.value = l.note || "";
  m_user.value = l.user || "unknown";

  if(l.type==="diaper") m_type.value = l.kind;

  modalBG.style.display="flex";
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ–°è¦è¿½åŠ ç”¨ */
function openModalForType(t){
  editIndex = null;

  m_type.value = t;
  m_time.value = nowDT();
  m_amount.value = "";
  m_temp.value = "";
  m_note.value = "";
  m_user.value = localStorage.getItem("username")||"unknown";

  modalBG.style.display="flex";
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ */
function closeModal(){
  modalBG.style.display="none";
}

/* ä¿å­˜ */
function saveEdit(){
  const type = m_type.value;
  const time = new Date(m_time.value).getTime();

  let obj = {
    type:type==="pee"||type==="poo"?"diaper":type,
    time:time,
    user:m_user.value || "unknown",
    note:m_note.value||""
  };

  if(type==="milk-fed"){
    obj.amount = Number(m_amount.value||0);
    obj.nextFeeding = time + Number(interval.value)*3600*1000;
  }
  if(type==="milk-made"){
    obj.vol = Number(m_amount.value||0);
    obj.temp = Number(m_temp.value||0);
  }
  if(type==="pee"||type==="poo"){
    obj.kind = type;
  }

  if(editIndex===null){
    DB.logs.unshift(obj);
  } else {
    DB.logs[editIndex]=obj;
  }

  sortLogs();
  saveData(DB);
  refresh();
  closeModal();
}

/* æ¬¡ã®æˆä¹³ */
function calcNextFeeding(){
  const feeds = DB.logs.filter(x=>x.type==="milk-fed");
  if(feeds.length===0){
    nextFeed.textContent="æ¬¡ã®æˆä¹³ï¼š--";
    return;
  }
  feeds.sort((a,b)=>b.time-a.time);
  const latest = feeds[0];
  nextFeed.textContent="æ¬¡ã®æˆä¹³ï¼š"+ new Date(latest.nextFeeding).toLocaleString();
}

/* æˆä¹³é–“éš”ä¿å­˜ */
function onIntervalChange(){
  saveInterval();
  recalcNextFeed();
}
function saveInterval(){
  localStorage.setItem("feed_interval", interval.value);
}
function loadIntervalSetting(){
  const v = localStorage.getItem("feed_interval");
  if(v) interval.value=v;
}
function recalcNextFeed(){
  const feeds = DB.logs.filter(x=>x.type==="milk-fed");
  if(feeds.length===0) return;
  feeds.sort((a,b)=>b.time-a.time);
  const l=feeds[0];
  l.nextFeeding = l.time + Number(interval.value)*3600*1000;
  saveData(DB);
  calcNextFeeding();
}

/* å±¥æ­´æŠ˜ã‚ŠãŸãŸã¿ */
function toggleLogs(){
  logsContainer.style.display =
    logsContainer.style.display==="none" ? "block" : "none";
}

/* å†·å´ */
let cooldownTimer=null;
let cooldownLeft=0;

function calcCoolSeconds(temp,vol){
  const target=40, base=114;
  return Math.round(base*(vol/200)*((temp-target)/30));
}
function manualStartCooldown(){
  cooldownLeft = calcCoolSeconds(
    Number(startTemp.value),
    Number(milkVol.value)
  );
  startCooldown();
}
function startCooldown(){
  if(cooldownTimer) clearInterval(cooldownTimer);
  updateCooldownDisplay();
  cooldownTimer=setInterval(()=>{
    cooldownLeft--;
    updateCooldownDisplay();
    if(cooldownLeft<=0){
      clearInterval(cooldownTimer);
      cooldownTimer=null;
      cooldownStatus.textContent="â„ï¸ å†·å´å®Œäº†ï¼";
      if(navigator.vibrate) navigator.vibrate([200,100,200]);
    }
  },1000);
}
function updateCooldownDisplay(){
  if(cooldownLeft<=0){
    cooldownStatus.textContent="å†·å´å®Œäº†ï¼";
    return;
  }
  const m=Math.floor(cooldownLeft/60);
  const s=cooldownLeft%60;
  cooldownStatus.textContent=`â„ï¸ å†·å´ä¸­â€¦ æ®‹ã‚Š ${m}åˆ†${s.toString().padStart(2,"0")}ç§’`;
}
</script>

</body>
</html>
