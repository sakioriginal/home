<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è‚²å…ãƒ­ã‚°ï¼ˆãƒŸãƒ«ã‚¯ãƒ»ã‚ªãƒ ãƒ„ãƒ»å†·å´ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: sans-serif; background:#f4f4f4; padding:20px;
  }
  h1 { text-align:center; }
  .card {
    background:white; margin:15px 0; padding:15px;
    border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1);
  }
  button {
    padding:10px 16px; margin:5px 0;
    font-size:16px; border:none; border-radius:6px;
    background:#4CAF50; color:white;
  }
  input {
    padding:5px; font-size:16px; width:80%;
    margin:5px;
  }
  #logs .log { padding:8px 0; border-bottom:1px solid #ddd; }
</style>
</head>

<body>

<h1>è‚²å…ãƒ­ã‚°ï¼ˆå®¶æ—å…±æœ‰ç‰ˆï¼‰</h1>

<!-- â–¼â–¼ åˆå›è¨­å®šç”»é¢ â–¼â–¼ -->
<div id="setupPage" class="card" style="display:none;">
  <h2>ğŸ” åˆæœŸè¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰</h2>
  <p>å®¶æ—ã®èª°ã‹1äººã® APIã‚­ãƒ¼ ã¨ BIN_ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

  <input id="apiKeyInput" placeholder="API KEY ã‚’å…¥åŠ›">
  <input id="binIdInput" placeholder="BIN ID ã‚’å…¥åŠ›">

  <button onclick="saveInitialSettings()">ä¿å­˜</button>
</div>


<!-- â–¼â–¼ æœ¬ç·¨ã‚¢ãƒ—ãƒª â–¼â–¼ -->
<div id="mainApp" style="display:none;">

  <!-- ãƒŸãƒ«ã‚¯ -->
  <div class="card">
    <h2>ğŸ¼ ãƒŸãƒ«ã‚¯ç®¡ç†</h2>
    <button onclick="makeMilk()">ãƒŸãƒ«ã‚¯ã‚’ä½œã£ãŸ</button>
    <button onclick="fedMilk()">é£²ã¾ã›ãŸï¼ˆé‡ã‚’å…¥åŠ›ï¼‰</button>

    <br><br>
    æˆä¹³é–“éš”ï¼š
    <select id="interval">
      <option value="3">3æ™‚é–“</option>
      <option value="2.5">2.5æ™‚é–“</option>
      <option value="4">4æ™‚é–“</option>
    </select>

    <h3 id="nextFeed">æ¬¡ã®æˆä¹³ï¼š--</h3>
  </div>

  <!-- å†·å´ -->
  <div class="card">
    <h2>â„ï¸ ãƒŸãƒ«ã‚¯å†·å´</h2>
    åˆæœŸæ¸©åº¦ï¼š<input id="startTemp" type="number" value="70"> â„ƒ  
    é‡ï¼š<input id="milkVol" type="number" value="200"> ml  
    <button onclick="manualStartCooldown()">å†·å´æ™‚é–“ã‚’è¨ˆç®—ã—ã¦é–‹å§‹</button>
    <h3 id="cooldownStatus">--</h3>

    <audio id="alarmSound">
      <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
    </audio>
  </div>

  <!-- ã‚ªãƒ ãƒ„ -->
  <div class="card">
    <h2>ğŸ’© ã‚ªãƒ ãƒ„</h2>
    <button onclick="addDiaper('pee')">ãŠã—ã£ã“</button>
    <button onclick="addDiaper('poo')">ã†ã‚“ã¡</button>
  </div>

  <!-- ãƒ­ã‚° -->
  <div class="card">
    <h2>ğŸ“– ãƒ­ã‚°ä¸€è¦§</h2>
    <div id="logs">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>
</div>


<script>
// ---------------------------------------------------------------
// â‘  localStorage ã® API_KEY/BIN_ID ã‚’ãƒã‚§ãƒƒã‚¯
// ---------------------------------------------------------------
function checkSettings() {
  const api = localStorage.getItem("jsonbin_api_key");
  const bin = localStorage.getItem("jsonbin_bin_id");

  if (!api || !bin) {
    // æœªè¨­å®š â†’ åˆå›è¨­å®šUIã‚’è¡¨ç¤º
    document.getElementById("setupPage").style.display = "block";
  } else {
    // è¨­å®šæ¸ˆ â†’ æœ¬ç·¨ã‚’è¡¨ç¤º
    document.getElementById("mainApp").style.display = "block";
    refresh(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
  }
}
checkSettings();


// ---------------------------------------------------------------
// â‘¡ åˆå›è¨­å®šã®ä¿å­˜
// ---------------------------------------------------------------
function saveInitialSettings() {
  const api = document.getElementById("apiKeyInput").value;
  const bin = document.getElementById("binIdInput").value;

  if (!api || !bin) {
    alert("API KEY ã¨ BIN_ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  localStorage.setItem("jsonbin_api_key", api);
  localStorage.setItem("jsonbin_bin_id", bin);

  alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
  location.reload();
}


// ---------------------------------------------------------------
// â‘¢ JSONBin load/saveï¼ˆlocalStorageã‚’ä½¿ç”¨ï¼‰
// ---------------------------------------------------------------
async function loadData() {
  const api = localStorage.getItem("jsonbin_api_key");
  const bin = localStorage.getItem("jsonbin_bin_id");
  const url = `https://api.jsonbin.io/v3/b/${bin}`;

  const res = await fetch(url, {
    headers: { "X-Master-Key": api }
  });

  const json = await res.json();
  return json.record || { logs: [] };
}

async function saveData(data) {
  const api = localStorage.getItem("jsonbin_api_key");
  const bin = localStorage.getItem("jsonbin_bin_id");
  const url = `https://api.jsonbin.io/v3/b/${bin}`;

  await fetch(url, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": api
    },
    body: JSON.stringify(data)
  });
}


// ---------------------------------------------------------------
// â‘£ ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ï¼‰
// ---------------------------------------------------------------
let DB = { logs: [] };

async function refresh() {
  DB = await loadData();
  renderLogs();
  calcNextFeeding();
}

// ğŸ¼ ãƒŸãƒ«ã‚¯
function makeMilk() {
  const now = Date.now();

  DB.logs.unshift({
    type: "milk-made",
    time: now,
    temp: Number(document.getElementById("startTemp").value),
    vol:  Number(document.getElementById("milkVol").value)
  });

  saveData(DB);
  renderLogs();
  autoStartCooldownFromMilk();
}

function fedMilk() {
  const amount = prompt("é£²ã‚“ã é‡ï¼ˆmlï¼‰", "150");
  if (!amount) return;

  const interval = parseFloat(document.getElementById("interval").value);
  const now = Date.now();
  const next = now + interval * 60 * 60 * 1000;

  DB.logs.unshift({
    type: "milk-fed",
    time: now,
    amount: Number(amount),
    nextFeeding: next
  });

  saveData(DB);
  renderLogs();
  calcNextFeeding();
}

// ğŸ’© ã‚ªãƒ ãƒ„
function addDiaper(kind) {
  DB.logs.unshift({
    type: "diaper",
    kind,
    time: Date.now()
  });

  saveData(DB);
  renderLogs();
}

// ğŸ“– è¡¨ç¤º
function renderLogs() {
  const box = document.getElementById("logs");
  box.innerHTML = "";

  DB.logs.forEach(l => {
    const d = document.createElement("div");
    d.className = "log";
    const t = new Date(l.time).toLocaleString();

    if (l.type === "milk-made") {
      d.textContent = `ğŸ¼ ãƒŸãƒ«ã‚¯ä½œæˆï¼š${t}ï¼ˆ${l.vol}ml / ${l.temp}â„ƒï¼‰`;
    } else if (l.type === "milk-fed") {
      d.textContent = `ğŸ‘¶ é£²ã¾ã›ãŸï¼š${t} / ${l.amount}ml`;
    } else if (l.type==="diaper") {
      d.textContent = (l.kind==="pee"?"ğŸ’§ ãŠã—ã£ã“":"ğŸ’© ã†ã‚“ã¡") + "ï¼š" + t;
    }

    box.appendChild(d);
  });
}

// æ¬¡ã®æˆä¹³
function calcNextFeeding() {
  const latest = DB.logs.find(l => l.type==="milk-fed");
  if (!latest) return;
  const dt = new Date(latest.nextFeeding);
  document.getElementById("nextFeed").textContent =
    "æ¬¡ã®æˆä¹³ï¼š" + dt.toLocaleString();
}

// â„ï¸ å†·å´
let cooldownTimer = null;
let cooldownLeft = 0;

function calcCoolSeconds(temp, vol) {
  const targetTemp = 40;
  const baseTime = 114;
  return Math.round(baseTime * (vol / 200) * ((temp - targetTemp) / 30));
}

function autoStartCooldownFromMilk() {
  const latest = DB.logs.find(l => l.type==="milk-made");
  if (!latest) return;
  startCooldown(calcCoolSeconds(latest.temp, latest.vol));
}

function manualStartCooldown() {
  const temp = Number(document.getElementById("startTemp").value);
  const vol = Number(document.getElementById("milkVol").value);
  startCooldown(calcCoolSeconds(temp, vol));
}

function startCooldown(seconds) {
  if (cooldownTimer) clearInterval(cooldownTimer);
  cooldownLeft = seconds;
  updateCooldownDisplay();

  cooldownTimer = setInterval(() => {
    cooldownLeft--;
    updateCooldownDisplay();

    if (cooldownLeft <= 0) {
      clearInterval(cooldownTimer);
      cooldownTimer = null;
      document.getElementById("cooldownStatus").textContent =
        "â„ï¸ å†·å´å®Œäº†ï¼ã‚‚ã†ã‚ã’ã‚‰ã‚Œã¾ã™ï¼";
      document.getElementById("alarmSound").play().catch(()=>{});
      if (navigator.vibrate) navigator.vibrate([200,100,200]);
    }
  }, 1000);
}

function updateCooldownDisplay() {
  const m = Math.floor(cooldownLeft / 60);
  const s = cooldownLeft % 60;
  document.getElementById("cooldownStatus").textContent =
    cooldownLeft <= 0
      ? "å†·å´å®Œäº†ï¼"
      : `â„ï¸ å†·å´ä¸­â€¦ æ®‹ã‚Š ${m}åˆ†${s.toString().padStart(2,"0")}ç§’`;
}
</script>

</body>
</html>
